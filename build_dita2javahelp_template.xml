<?xml version="1.0" encoding="UTF-8"?>
<!--
This file is part of the DITA Open Toolkit project.

Copyright 2006 IBM Corporation

See the accompanying LICENSE file for applicable license.
-->
<project xmlns:dita="http://dita-ot.sourceforge.net" name="dita2javahelp">

  <target name="dita2javahelp.init">
    <property name="html-version" value="html"/>
    <property name="temp.output.dir.name" value="temp_jar_dir"/>
    <property name="clean-preprocess.use-result-filename" value="false"/>
    <property name="preprocess.copy-image.skip" value="true"/>
  </target>
    

    <target name="dita2javahelp"
            unless="noMap"
            depends="dita2javahelp.init,
                     build-init,
                     preprocess2,
                     javahelp.topics,
                     javahelp.copy-image,
                     copy-css,
                     dita.map.javahelp,
                     compile.Java.Help,
                     javahelp.jar"/>

  <target name="javahelp.copy-image" description="Copy image files">
    <copy todir="${dita.output.dir}" failonerror="false">
      <dita-fileset format="image"/>
      <job-mapper type="temp"/>
    </copy>
  </target>

  <target name="javahelp.topics"
          depends="xhtml.init,
                   xhtml.image-metadata">
    <topics.html>
      <dita:extension id="dita.conductor.xhtml.param" behavior="org.dita.dost.platform.InsertAction"/>
      <dita:extension id="dita.conductor.html.param" behavior="org.dita.dost.platform.InsertAction"/>
    </topics.html>
  </target>


  <target name="dita.map.javahelp"
            depends="dita.map.javahelp.init,
                     dita.map.javahelp.toc, dita.map.javahelp.map,
                     dita.map.javahelp.set, dita.map.javahelp.index">
    </target>

    <target name="dita.map.javahelp.init"
            description="Init properties for JavaHelp">
        <condition property="args.javahelp.toc" value="${dita.map.filename.root}">
            <not>
                <isset property="args.javahelp.toc" />
            </not>
        </condition>
        <condition property="out.ext" value=".html">
            <not>
                <isset property="out.ext" />
            </not>
        </condition>
        <condition property="args.javahelp.map" value="${dita.map.filename.root}">
            <not>
                <isset property="args.javahelp.map" />
            </not>
        </condition>
    </target>

    <target name="dita.map.javahelp.toc"
            depends="dita.map.javahelp.init"
            description="Build JavaHelp TOC file">
        <local name="javahelp.toc.output.dir"/>
        <condition property="javahelp.toc.output.dir" value="${dita.output.dir}" else="${_dita.map.output.dir}">
          <isset property="inner.transform"/>
        </condition>
        <xslt
              basedir="${dita.temp.dir}"
              destdir="${javahelp.toc.output.dir}"
              includesfile="${dita.temp.dir}/${user.input.file.listfile}"
              classpathref="dost.class.path"
              style="${dita.plugin.org.dita.javahelp.dir}/xsl/map2javahelptoc.xsl">
          <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"/>
            <param name="OUTEXT" expression="${out.ext}" if="out.ext" />
            <mergemapper to="${args.javahelp.toc}.xml"/>
          <xmlcatalog refid="dita.catalog"/>
        </xslt>
    </target>

    <target name="dita.map.javahelp.map"
            depends="dita.map.javahelp.init"
            description="Build JavaHelp Map file">
        <local name="javahelp.map.output.dir"/>
        <condition property="javahelp.map.output.dir" value="${dita.output.dir}" else="${_dita.map.output.dir}">
          <isset property="inner.transform"/>
        </condition>
        <xslt
              basedir="${dita.temp.dir}"
              destdir="${javahelp.map.output.dir}"
              includesfile="${dita.temp.dir}/${user.input.file.listfile}"
              classpathref="dost.class.path"
              style="${dita.plugin.org.dita.javahelp.dir}/xsl/map2javahelpmap.xsl">
          <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"/>
            <param name="OUTEXT" expression="${out.ext}" if="out.ext" />
            <mergemapper to="${args.javahelp.map}.jhm"/>
          <xmlcatalog refid="dita.catalog"/>
        </xslt>
    </target>

    <target name="dita.map.javahelp.set"
            depends="dita.map.javahelp.init, dita.map.javahelp.map"
            description="Build JavaHelp Set file">
        <local name="javahelp.set.output.dir"/>
        <condition property="javahelp.set.output.dir" value="${dita.output.dir}" else="${_dita.map.output.dir}">
          <isset property="inner.transform"/>
        </condition>
        <xslt
              basedir="${dita.temp.dir}"
              destdir="${javahelp.set.output.dir}"
              includesfile="${dita.temp.dir}/${user.input.file.listfile}"
              classpathref="dost.class.path"
              style="${dita.plugin.org.dita.javahelp.dir}/xsl/map2javahelpset.xsl">
          <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"/>
            <param name="javahelpmap" expression="${args.javahelp.map}" />
            <param name="javahelptoc" expression="${args.javahelp.toc}" />
          <param name="basedir" expression="${basedir}"/>
          <param name="outputdir" expression="${dita.output.dir}"/>
            <mergemapper to="${dita.map.filename.root}_helpset.hs"/>
          <xmlcatalog refid="dita.catalog"/>
        </xslt>
    </target>

    <target name="dita.map.javahelp.index"
            description="Build JavaHelp Index file">
        <local name="javahelp.index.output.dir"/>
        <condition property="javahelp.index.output.dir" value="${dita.output.dir}" else="${_dita.map.output.dir}">
          <isset property="inner.transform"/>
        </condition>
        <pipeline message="Extract index term."
                  tempdir="${dita.temp.dir}"
                  inputmap="${user.input.file}">
          <module class="org.dita.dost.module.IndexTermExtractModule">
            <param name="output" location="${javahelp.index.output.dir}/${dita.map.filename.root}.xml"/>
            <param name="targetext" value=".html"/>
            <param name="indextype" value="javahelp"/>
            <param name="indexclass" value="org.dita.dost.writer.JavaHelpIndexWriter"/>
            <param name="encoding" value="${args.dita.locale}" if="args.dita.locale"/>
          </module>
        </pipeline>
    </target>

    <target name="compile.Java.Help"
            if="env.JHHOME"
            description="Compile Java Help output">
        <property name="compiler.jar" location="${env.JHHOME}${file.separator}javahelp${file.separator}bin${file.separator}jhindexer.jar"/>
        <delete dir="${dita.output.dir}/JavaHelpSearch" />
        <java jar="${compiler.jar}" fork="true">
            <arg value="${dita.output.dir}" />
        </java>
    </target>
  
  <target name="javahelp.jar">
    <property name="args.javahelp.jar.name" value="${dita.map.filename.root}.jar"/>
    <jar destfile="${output.dir}/${args.javahelp.jar.name}" basedir="${dita.output.dir}">
      <include name="**/*"/>
    </jar>
  </target>  

</project>
